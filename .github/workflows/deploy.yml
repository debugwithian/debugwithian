name: ðŸš€ Auto Deploy to AWS with AI Code Review (Groq)

on:
  pull_request:
    branches: [prod_v2]
    types: [opened, synchronize, reopened]

  push:
    branches: [prod_v2]

  workflow_dispatch:

jobs:

  ai_code_review:
    name: ðŸ¤– AI Code Review via Groq
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      review_status: ${{ steps.save_status.outputs.review_status }}
      review_body: ${{ steps.save_status.outputs.review_body }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch PR branches
        run: |
          git fetch origin prod_v2
          git fetch origin +refs/pull/${{ github.event.pull_request.number }}/head:pr_branch
          git checkout pr_branch

      - name: Generate diff
        id: get_diff
        run: |
          BASE=$(git merge-base HEAD origin/prod_v2)

          if git diff --quiet $BASE HEAD; then
            echo "diff=" >> $GITHUB_ENV
            exit 0
          fi

          DIFF_CONTENT=$(git diff $BASE HEAD)
          # safely encode for GitHub env
          {
            echo "diff<<EOF"
            printf '%s\n' "$DIFF_CONTENT"
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Call Groq AI Review
        id: groq_review
        run: |
          if [ -z "${diff}" ]; then
            echo '{"status":"PASSED","body":"No changes detected."}' > ai_review.json
            exit 0
          fi

          PAYLOAD=$(jq -n --arg diff "$diff" '{
            model: "llama-3.1-8b-instant",
            messages: [
              {
                role: "system",
                content: "You are a senior software engineer performing a strict code review. Output ONLY one JSON object: {\"status\":\"CRITICAL_ISSUE|IMPROVEMENTS|PASSED\",\"body\":\"Readable PR comment\"}. The body must reference filenames only (index.html, script.js) and provide line numbers + code blocks. If syntax errors exist, return CRITICAL_ISSUE."
              },
              {
                role: "user",
                content: ("Review the following diff:\n\n" + $diff)
              }
            ]
          }')

          curl -s https://api.groq.com/openai/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.GROQ_API_KEY }}" \
            -d "$PAYLOAD" \
            | jq -r '.choices[0].message.content' > ai_review.json

      - name: Save AI review status & body
        id: save_status
        run: |
          STATUS=$(jq -r '.status' ai_review.json)
          BODY=$(jq -r '.body' ai_review.json)

          echo "review_status=$STATUS" >> $GITHUB_OUTPUT

          {
            echo "review_body<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Post PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = process.env.REVIEW_BODY || `${{ steps.save_status.outputs.review_body }}`;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Fail if CRITICAL
        if: ${{ steps.save_status.outputs.review_status == 'CRITICAL_ISSUE' }}
        run: exit 1


  deploy:
    name: ðŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/prod_v2'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H YOUR_SERVER_IP >> ~/.ssh/known_hosts

      - name: Deploy to AWS
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@YOUR_SERVER_IP "
            cd /var/www/yourapp &&
            git fetch origin prod_v2 &&
            git reset --hard origin/prod_v2 &&
            npm install &&
            pm2 restart all
          "
