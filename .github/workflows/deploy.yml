name: ðŸš€ Auto Deploy to AWS with AI Code Review (Groq)

on:
  push:
    branches:
      - prod_v2
  workflow_dispatch:  # Enables manual deployment trigger

jobs:
  ai_code_review:
    - name: Run AI Code Review (Groq)
  env:
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
    run: |
      echo "Running AI Code Review through Groq..."

      # Fetch full history to access previous commits
      git fetch --unshallow || true
      git fetch origin prod_v2

      # Compare last two commits in prod_v2
      git diff HEAD~1 HEAD | tail -n 2000 > diff.txt

      # Build payload safely to avoid oversized arguments
      jq -n --arg diff "$(cat diff.txt)" '{
        model: "llama-3.1-70b-versatile",
        messages: [
          {role: "system", "content": "You are a senior software engineer performing a concise code review. Flag bugs, vulnerabilities, or critical issues."},
          {role: "user", "content": "Review the following git diff for potential problems, bad practices, or security issues:\n\n\($diff)"}
        ]
      }' > payload.json

      # Send to Groq API
      REVIEW=$(curl -s https://api.groq.com/openai/v1/chat/completions \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $GROQ_API_KEY" \
        --data-binary @payload.json | jq -r '.choices[0].message.content')

      echo "---- AI Code Review (Groq) ----"
      echo "$REVIEW" | tee ai_review_output.txt

      if echo "$REVIEW" | grep -qi "critical issue"; then
        echo "âŒ Critical issue detected. Stopping deployment."
        exit 1
      fi


  deploy:
    name: ðŸš€ Deploy to AWS (Manual Trigger)
    runs-on: ubuntu-latest
    needs: ai_code_review
    if: github.event_name == 'workflow_dispatch'  # Run only when triggered manually

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 3.232.21.89 >> ~/.ssh/known_hosts

      - name: Deploy and restart app on AWS
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@3.232.21.89 "
            cd /home/ubuntu &&
            git fetch origin prod_v2 &&
            git reset --hard origin/prod_v2 &&
            npm install &&
            pm2 restart all
          "
